{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{% static 'css/agregar_recetas.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Cooking</title>
</head>
<body>
    <header>
        <h2>DC</h2>
        <div class="banner-buttons">
            {% if user.is_authenticated %}
                <button onclick="window.location.href='{% url 'index' %}'">Volver</button>
            {% endif %}
        </div>
    </header>
    <h1>Añade una nueva receta</h1>

    <!-- Mostrar el botón solo si el usuario es ADMIN -->
    {% if es_admin %}
        <form method="POST">
            {% csrf_token %}
            <h2>Detalles de la receta</h2>
            {{ receta_form.as_p }}

            <h2>Ingredientes</h2>
            <div id="formset">
                {{ formset.management_form }}
                <div id="formset-container">
                    {% for form in formset %}
                        <div class="formset-row">
                            {{ form.as_p }}
                            <button type="button" class="delete-row">Eliminar</button>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <button type="button" id="add-row">Agregar Ingrediente</button>
            <button type="submit">Guardar receta</button>
        </form>
    {% else %}
        <p>No tienes permisos para añadir recetas.</p>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const formsetContainer = document.getElementById('formset-container');
            const addRowButton = document.getElementById('add-row');
            const totalForms = document.querySelector('#id_receta_ingredientes-TOTAL_FORMS');
        
            addRowButton.addEventListener('click', function () {
                const currentFormCount = parseInt(totalForms.value); // Número actual de formularios
                const newForm = formsetContainer.children[0].cloneNode(true); // Clonar el primer formulario
        
                // Actualizar los atributos name e id de los campos en el formulario clonado
                newForm.querySelectorAll('input, select').forEach(function (field) {
                    // Reemplazar el índice actual por el nuevo índice
                    const name = field.name.replace(/-\d+-/, `-${currentFormCount}-`);
                    const id = field.id.replace(/-\d+-/, `-${currentFormCount}-`);
                    field.name = name;
                    field.id = id;
                    field.value = ''; // Limpiar el valor del campo
                });
        
                // Actualizar los for de los labels si los hay
                newForm.querySelectorAll('label').forEach(function (label) {
                    if (label.htmlFor) {
                        label.htmlFor = label.htmlFor.replace(/-\d+-/, `-${currentFormCount}-`);
                    }
                });
        
                // Agregar el formulario clonado al contenedor
                formsetContainer.appendChild(newForm);
        
                // Incrementar el número total de formularios en el management_form
                totalForms.value = currentFormCount + 1;

                
            });

            formsetContainer.addEventListener('click', function (e) {
                if (e.target.classList.contains('delete-row')) {
                    e.preventDefault(); // Prevenir cualquier acción predeterminada (por si acaso)
                    e.target.closest('.formset-row').remove();
                    totalForms.value = formsetContainer.children.length; // Actualizar el contador de formularios
                }
            });

        });
    </script>
</body>
</html>
